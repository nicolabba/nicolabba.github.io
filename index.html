<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <meta charset="UTF-8">
    <title>Pixi Tutorial</title>
</head>
<script src="./pixi.min.js"></script>
<body>
<script type="text/javascript">
    //Aliases
    let Application = PIXI.Application,
        loader = PIXI.loader,
        resources = PIXI.loader.resources,
        Sprite = PIXI.Sprite,
        Text = PIXI.Text;
    loader
        .add("assets/Blue Ball.png")
        .add("assets/trail.png")
        .add("assets/Red Ball.png");

    //Create a Pixi Application
    let app;

    let score, scoreValue, blueBall, redBalls, gameOver;

    class RedBall {
        instance;
        direction;
        speed;
        vx;
        vy;
        size;

        constructor(_direction = Math.random() * 2 * Math.PI, _speed = 10, _size = 100) {
            this.instance = new Sprite(
                resources["assets/Red Ball.png"].texture
            );

            this.speed = _speed;

            this.direction = _direction;
            this.vx = Math.cos(this.direction) * this.speed;
            this.vy = Math.sin(this.direction) * this.speed;

            this.instance.width = _size;
            this.instance.height = _size;
            this.size = _size;

            this.instance.x = Math.random() * window.innerWidth - this.size;
            this.instance.y = Math.random() * window.innerHeight - this.size;
            while (Math.pow((Math.pow(this.center.x - blueBall.center.x, 2) + Math.pow(this.center.y - blueBall.center.y, 2)), 0.5) < (blueBall.size / 2 + this.size / 2)) {
                this.instance.x = Math.random() * window.innerWidth - this.size;
                this.instance.y = Math.random() * window.innerHeight - this.size;
            }
            app.stage.addChild(this.instance);
        }

        execute(delta) {
            this.move(delta);
        }

        move(delta) {
            let hitBorder = this.borderCollision(delta);
            if (hitBorder !== 0) {
                this.changeDirection(hitBorder);
            }
            this.instance.x += this.vx + delta;
            this.instance.y += this.vy + delta;
        }

        // LEFT: 1, RIGHT: 2, TOP: 3, BOTTOM: 4
        borderCollision(delta) {
            let height = app.renderer.height;
            let width = app.renderer.width;

            if (this.instance.x + this.vx + delta < 0) {
                return 1;
            }
            if (this.instance.x + this.instance.width + this.vx + delta > width) {
                return 2;
            }
            if (this.instance.y + this.vy + delta < 0) {
                return 3;
            }
            if (this.instance.y + this.instance.height + this.vy + delta > height) {
                return 4;
            }
            return 0;
        }

        changeDirection(hitBorder) {
            if (hitBorder === 1 || hitBorder === 2) {
                this.vx = -this.vx;
            }
            if (hitBorder === 3 || hitBorder === 4) {
                this.vy = -this.vy;
            }
        }

        get center() {
            return {x: this.instance.x + this.size / 2, y: this.instance.y + this.size / 2}
        }
    }

    class BlueBall {
        instance;
        size;

        constructor(_size = 100) {
            this.instance = new Sprite(
                resources["assets/Blue Ball.png"].texture
            );
            app.stage.addChild(this.instance);

            this.instance.width = _size;
            this.instance.height = _size;
            this.size = _size;
            this.instance.x = -1000;
            this.instance.y = -1000;
            app.stage.mousemove = (event) => {
                this.instance.x = event.data.global.x - this.size / 2;
                this.instance.y = event.data.global.y - this.size / 2;
            };
        }

        execute(delta) {
            gameOver = blueBall.redBallCollision();
        }

        redBallCollision() {
            let result = false;
            redBalls.forEach(redBall => {
                let distance = Math.pow((Math.pow(redBall.center.x - blueBall.center.x, 2) + Math.pow(redBall.center.y - blueBall.center.y, 2)), 0.5);
                if (redBall.size && distance < (this.size / 2 + redBall.size / 2)) {
                    result = true;
                }
            });
            return result;
        }

        get center() {
            return {x: this.instance.x + this.size / 2, y: this.instance.y + this.size / 2}
        }
    }

    function setup() {
        redBalls = [];
        gameOver = false;
        app.stage.interactive = true;
        blueBall = new BlueBall();
        redBalls.push(new RedBall());
        scoreValue = 0;
        score = new Text(scoreValue, {fill: 'white'});
        score.x = app.renderer.width - 200;
        score.y = 50;
        app.stage.addChild(score);

        app.stage.click = () => {
            redBalls.push(new RedBall());
        };
        app.ticker.add(delta => gameLoop(delta));
    }

    function startGame() {
        document.getElementsByClassName('post-game-menu')[0].setAttribute('style', '');
        app = new Application({
            width: 256,         // default: 800
            height: 256,        // default: 600
            antialias: true,    // default: false
            transparent: false, // default: false
            resolution: 1       // default: 1
        });
        app.renderer.view.style.position = "absolute";
        app.renderer.view.style.display = "block";
        app.renderer.autoResize = true;
        app.renderer.resize(window.innerWidth, window.innerHeight);
        app.renderer.autoResize = true;

        if (document.getElementsByClassName('pre-game-menu').length > 0)
            document.getElementsByClassName('pre-game-menu')[0].remove();
        //Add the canvas that Pixi automatically created for you to the HTML document
        document.body.appendChild(app.view);

        loader.load(setup);
    }

    function endGame() {
        document.getElementsByClassName('post-game-menu')[0].setAttribute('style', 'display: flex');
        document.getElementsByClassName('score')[0].innerHTML = 'Score: ' + scoreValue.toFixed(0);
        app.destroy(true);
    }

    function gameLoop(delta) {
        if (!gameOver) {
            scoreValue += redBalls.length + delta;
            score.text = scoreValue.toFixed(0);
            redBalls.forEach(redBall => redBall.execute(delta));
            blueBall.execute(delta);
        }
        else {
            app.ticker.stop();
            endGame();
        }
    }
</script>
<div class="pre-game-menu">
    <button class="start" onclick="startGame()">Start game</button>
</div>
<div class="post-game-menu">
    <p class="score"></p>
    <button class="start" onclick="startGame()">Restart game</button>
</div>
</body>
</html>